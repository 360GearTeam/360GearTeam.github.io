---
layout: post
title: "Samba远程代码执行漏洞(CVE-2017-7494)分析"
---

![][1]

**Author: cyg07@GearTeam && redrain@360CERT**

# 概述

Samba是在Linux和UNIX系统上实现SMB协议的一个软件。2017年5月24日Samba发布了4.6.4版本，中间修复了一个严重的远程代码执行漏洞，漏洞编号CVE-2017-7494，漏洞影响了Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本。360网络安全中心 和 360信息安全部的Gear Team第一时间对该漏洞进行了分析，确认属于严重漏洞，可以造成远程代码执行。

<!-- more -->

# 漏洞简述

漏洞编号：CVE-2017-7494

危害等级：严重

影响版本：Samba 3.5.0 和包括4.6.4/4.5.10/4.4.14中间版本

漏洞描述：2017年5月24日Samba发布了4.6.4版本，修复了一个严重的远程代码执行漏洞，该漏洞影响了Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本。

# 技术分析

如官方所描述，该漏洞只需要通过一个可写入的Samba用户权限就可以提权到samba所在服务器的root权限（samba默认是root用户执行的）。

从Patch来看的话，is_known_pipename函数的pipename中存在路径符号会有问题：

![][2]

再延伸下smb_probe_module函数中就会形成公告里说的加载攻击者上传的dll来任意执行代码了：

## 具体攻击过程：

构造一个有’/’ 符号的管道名或路径名，如 “`/home/toor/cyg07.so`”

通过smb的协议主动让服务器smb返回该FID

后续直接请求这个FID就进入上面所说的恶意流程

具体攻击结果如下：

1.尝试加载　“`/home/toor/cyg07.so`” 恶意so

![][3]

2.其中so 代码如下(加载时会调用　samba_init_module 导出函数)

![][4]

3.最后我们可以在`/tmp/360sec`中看到实际的执行权限(带root权限)

![][5]

# PoC

暂不公开

# 解决方案


360网络安全响应中心和360信息安全部建议使用受影响版本的用户立即通过以下方式来进行安全更新操作，

1. 使用源码安装的Samba用户，请尽快下载最新的Samba版本手动更新；
2. 使用二进制分发包（RPM等方式）的用户立即进行yum，apt-get update等安全更新操作；

**缓解策略**：用户可以通过在smb.conf的`[global]`节点下增加　`nt pipe support = no` 选项，然后重新启动samba服务， 以此达到缓解该漏洞的效果。

[1]: https://p5.ssl.qhimg.com/t01a56a15435c03e9e4.jpg
[2]: https://p1.ssl.qhimg.com/t01d23335c5e70fb508.png
[3]: https://p4.ssl.qhimg.com/t013cf2bdfd2889d420.png
[4]: https://p4.ssl.qhimg.com/t01b8231f3b9add8078.png
[5]: https://p5.ssl.qhimg.com/t010c6fba1c8d5a9095.png